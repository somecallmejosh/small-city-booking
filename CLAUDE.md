# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Small City Studio is a Rails 8.1.1 booking app for a single-room recording studio. Customers browse available time slots, hold them for 2 minutes, pay via Stripe Checkout, and receive confirmation. One admin manages all slots, bookings, agreements, and settings.

**Stack:** Rails 8.1.1 · PostgreSQL · Hotwire (Turbo + Stimulus) · TailwindCSS · Propshaft · Importmap · ViewComponent · Solid Queue · Stripe

**Time zone:** All times stored UTC, displayed in `America/New_York`. `config.time_zone = "Eastern Time (US & Canada)"` in `application.rb`.

---

## Common Commands

```bash
# Development
bin/rails server
bin/rails db:migrate
bin/rails db:seed

# Tests (full suite — also runs SimpleCov; CI fails below 95% coverage)
bundle exec rspec

# Run a single spec file
bundle exec rspec spec/models/slot_spec.rb

# Run a single example by line number
bundle exec rspec spec/models/slot_spec.rb:42

# Linting
bin/rubocop
bin/rubocop -a          # auto-correct safe offenses

# Security scans
bin/brakeman --no-pager
bin/bundler-audit
bin/importmap audit
```

CI runs four jobs: `scan_ruby` (Brakeman + Bundler Audit), `scan_js` (importmap audit), `lint` (RuboCop), and `test` (RSpec + Chrome via Cuprite). All must pass before merge.

---

## Architecture

### Auth

Generated by `rails generate authentication`. Uses `Current.user` (via `Current < CurrentAttributes`). `allow_unauthenticated_access` is required on controllers that are publicly accessible (e.g., `HomeController`, `WebhooksController`).

- Field is `email_address` (not `email`) — Rails 8 convention
- Password min 12 chars; validation skipped on update unless `password.present?`
- Password reset uses `generates_token_for :password_reset` — call `user.generate_token_for(:password_reset)`

### Admin Namespace

All admin controllers inherit from `Admin::BaseController`, which sets `layout "admin"` and enforces `require_admin` (redirects non-admins to root). Admin is identified by `user.admin? == true`.

### Slot Hold Flow (core booking logic)

1. `SlotHoldsController#create`: wraps hold acquisition in a DB transaction with `SELECT FOR UPDATE SKIP LOCKED`. If any slot is not `open`, rolls back. On success, sets `status: "held"`, `held_by_user_id`, `held_until: 2.minutes.from_now`, creates a pending `Booking` + `BookingSlot` records, stores `session[:pending_booking_id]`.
2. `BookingsController#new/create`: reads pending booking from session, validates hold hasn't expired, creates Stripe Checkout Session, redirects to Stripe.
3. `WebhooksController#stripe`: on `payment_intent.succeeded`, verifies slots are still held by the booking's user, confirms booking + transitions slots to `reserved`, creates `AgreementAcceptance`. On `payment_intent.payment_failed`, releases slots back to `open` and cancels booking. CSRF skipped, Stripe signature verified.
4. `HoldExpiryJob`: releases expired holds every minute (configured in `config/recurring.yml` for production via Solid Queue).

`Slot.available` scope includes lazy cleanup: `status = 'open' OR (status = 'held' AND held_until < NOW())` so expired holds don't block the calendar between job runs.

### Pagy

Version 43.x — **no** `Pagy::Backend`/`Pagy::Frontend` modules. Controllers use `include Pagy::Method`; views call `@pagy.series_nav`.

### Styling Conventions

Tailwind classes are never repeated inline. Shared styles live in `app/helpers/style_helper.rb`:

| Method | Purpose |
|---|---|
| `btn_primary` | Primary action button |
| `btn_secondary` | Secondary/cancel button |
| `btn_danger` | Destructive action button |
| `input_field` | Form text inputs |
| `form_label` | Form labels |
| `card` | Card container |
| `page_container` | Page-level max-width wrapper |
| `session_form_wrapper` | Auth form container |
| `slot_status_badge_classes(status)` | Color badge for slot status |
| `slot_button_classes(slot)` | Calendar slot button styling |

Component-private styles go as private methods on the ViewComponent class, not in `StyleHelper`.

### ViewComponent

Used for any reusable UI element. Components live in `app/components/`, specs in `spec/components/`. Current components: `FlashMessageComponent`, `ConfirmationDialogComponent`, `BreadcrumbComponent`.

- `FlashMessageComponent`: `type:` (`:notice`/`:alert`/`:error`), `message:` — dismiss button uses `aria-label="Dismiss"`
- `ConfirmationDialogComponent`: `<dialog>` element, `aria-modal="true"`, bottom-sheet on mobile / modal on desktop
- `BreadcrumbComponent`: `items:` array of `{label:, path:}` — last item gets `aria-current="page"`

Component specs use `render_inline` via `ViewComponent::TestHelpers` (included for `type: :component`).

### Stimulus Controllers

- `slot_selection_controller.js`: manages multi-slot selection (consecutive-only), submits hidden `slot_ids[]` inputs
- `countdown_timer_controller.js`: reads `expiresAt` value, counts down, disables pay button and shows expired message at zero

### Models — Key Behaviors

- `Agreement#version`: auto-assigned in `before_validation on: :create` (not `before_create`). `Agreement.current` = most recently published; returns `nil` if none — always create one in tests.
- `StudioSetting.current` = singleton via `first_or_create!`.
- `Slot::STATUSES = %w[open held reserved cancelled]`. Broadcasts via `after_update_commit` to `"slots"` Turbo Stream channel.
- `Booking::STATUSES = %w[pending confirmed cancelled completed]`.
- `Booking#within_cancellation_window?` returns `true` if earliest slot starts after `cancellation_hours.hours.from_now`.
- `BookingSlot` has unique index on `[:booking_id, :slot_id]`.
- `BulkSlotCreator` service (`app/services/`) handles overnight time ranges (e.g., 22:00 → 02:00 spanning midnight).

---

## Testing

**Default driver:** `:rack_test` (fast). Use `driven_by(:cuprite)` in system specs that require JavaScript. Include `js: true` metadata to activate `:cuprite`.

**Key support files:**
- `spec/support/capybara.rb` — Cuprite setup (headless Chrome, 1200×800)
- `spec/support/webmock.rb` — `disable_net_connect!(allow_localhost: true)`
- `spec/support/vcr.rb` — cassettes at `spec/fixtures/vcr_cassettes`; `ignore_localhost = true` (required for Cuprite's Capybara server health checks)
- `spec/support/stripe_helpers.rb` — `stripe_webhook_payload(type:, data:)` helper included in `type: :request` specs

**Stripe in tests:**
- Env vars set in `rails_helper`: `STRIPE_SECRET_KEY=sk_test_fake`, `STRIPE_WEBHOOK_SECRET=whsec_test_secret`
- Stub Stripe HTTP with WebMock; use VCR cassettes for recorded interactions
- HMAC for webhook tests uses the **full** secret string (including `whsec_` prefix) as the HMAC key

**Sign-in forms** have no visible labels — use `fill_in "email_address"` and `fill_in "password"` (field IDs) in system specs.

**SimpleCov:** Excludes `app/channels/` (ActionCable requires live WebSocket). Threshold: 95% (currently ~98%).

**Concurrency specs** use `database_cleaner-active_record` with truncation strategy.

---

## Environment Variables

```
DATABASE_URL
RAILS_MASTER_KEY
STRIPE_SECRET_KEY
STRIPE_PUBLISHABLE_KEY
STRIPE_WEBHOOK_SECRET
VAPID_PUBLIC_KEY
VAPID_PRIVATE_KEY
SMTP_HOST / SMTP_USER / SMTP_PASSWORD
```
